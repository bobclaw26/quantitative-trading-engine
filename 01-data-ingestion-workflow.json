{
  "name": "Quantitative Trading Engine - Market Data Ingestion",
  "nodes": [
    {
      "name": "Trigger - Every 5 minutes",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [0, 0],
      "parameters": {
        "cronExpression": "*/5 * * * *",
        "timezone": "UTC"
      }
    },
    {
      "name": "Generate Run ID",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [200, 0],
      "parameters": {
        "functionCode": "const run_id = 'INGEST-' + Date.now() + '-' + Math.random().toString(36).substring(7);\nreturn [{ json: { run_id, timestamp: new Date().toISOString() } }];"
      }
    },
    {
      "name": "Fetch Polygon API - Batch Symbols",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [400, 0],
      "parameters": {
        "functionCode": "const symbols = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'JPM', 'BAC', 'WFC', 'XOM', 'CVX', 'MCD', 'NKE', 'COST'];\nreturn symbols.map(s => ({ json: { symbol: s } }));"
      }
    },
    {
      "name": "HTTP Request - Alpha Vantage Prices",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [600, 0],
      "parameters": {
        "method": "GET",
        "url": "=https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol={{$json.symbol}}&apikey={{$env.ALPHA_VANTAGE_API_KEY}}&outputsize=full",
        "returnFullResponse": false
      },
      "onError": "continueRegardless"
    },
    {
      "name": "Transform Price Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [800, 0],
      "parameters": {
        "functionCode": "return items.map(item => {\n  const symbol = item.json.symbol;\n  const response = item.json;\n  \n  const timeSeries = response['Time Series (Daily)'] || {};\n  const dates = Object.keys(timeSeries).sort().reverse();\n  \n  if (dates.length === 0) {\n    return null;\n  }\n  \n  const latestDate = dates[0];\n  const priceData = timeSeries[latestDate];\n  \n  return {\n    json: {\n      symbol: symbol,\n      timestamp: new Date().toISOString(),\n      close: parseFloat(priceData['4. close']) || 0,\n      volume: parseInt(priceData['5. volume']) || 0,\n      open: parseFloat(priceData['1. open']) || 0,\n      high: parseFloat(priceData['2. high']) || 0,\n      low: parseFloat(priceData['3. low']) || 0\n    }\n  };\n}).filter(d => d && d.json.close > 0);"
      }
    },
    {
      "name": "Insert into market_prices Table",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 2,
      "position": [1000, 0],
      "parameters": {
        "dataTableName": "market_prices",
        "mode": "insert",
        "columns": ["symbol", "timestamp", "close", "volume", "open", "high", "low"]
      }
    },
    {
      "name": "Log Ingestion Status",
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 2,
      "position": [1200, 0],
      "parameters": {
        "dataTableName": "ingestion_logs",
        "mode": "insert",
        "columns": ["run_id", "timestamp", "status", "records_inserted", "error_message"]
      }
    },
    {
      "name": "Error Handler",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1000, 200],
      "parameters": {
        "functionCode": "return [{ json: { status: 'failed', error: items[0]?.json?.error || 'Unknown error', timestamp: new Date().toISOString() } }];"
      },
      "onError": "stopExecution"
    }
  ],
  "connections": {
    "Trigger - Every 5 minutes": {
      "main": [[{ "node": "Generate Run ID", "branch": 0, "index": 0 }]]
    },
    "Generate Run ID": {
      "main": [[{ "node": "Fetch Polygon API - Batch Symbols", "branch": 0, "index": 0 }]]
    },
    "Fetch Polygon API - Batch Symbols": {
      "main": [[{ "node": "HTTP Request - Polygon Prices", "branch": 0, "index": 0 }]]
    },
    "HTTP Request - Polygon Prices": {
      "main": [[{ "node": "Transform Price Data", "branch": 0, "index": 0 }]]
    },
    "Transform Price Data": {
      "main": [[{ "node": "Insert into market_prices Table", "branch": 0, "index": 0 }]]
    },
    "Insert into market_prices Table": {
      "main": [[{ "node": "Log Ingestion Status", "branch": 0, "index": 0 }]]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "errorHandler": "Error Handler"
  },
  "active": false
}
