# Quantitative Trading Engine - Data Tables Schema

All tables are created in n8n Data Tables (cloud-native, no external DB required).

## 1. market_prices
**Purpose:** Store OHLCV price data for all tracked symbols.

| Column | Type | Description |
|--------|------|-------------|
| symbol | String | Stock ticker (AAPL, MSFT, etc.) |
| timestamp | DateTime | UTC timestamp of price quote |
| close | Number | Closing price |
| open | Number | Opening price |
| high | Number | Day high |
| low | Number | Day low |
| volume | Number | Trading volume |

**Indexes:** symbol, timestamp (compound for efficient lookups)
**Retention:** Keep last 90 days of data (rolling window)
**Update Frequency:** Every 5 minutes (via Polygon API)

---

## 2. signals
**Purpose:** Store trading signals generated by the three strategies.

| Column | Type | Description |
|--------|------|-------------|
| symbol | String | Stock ticker or pair (e.g., "MSFT/GOOGL") |
| strategy_type | String | Enum: "mean_reversion", "momentum", "statistical_arbitrage" |
| signal | Number | -1 (short), 0 (neutral), 1 (long) |
| signal_strength | Number | 0-1 confidence score |
| z_score | Number | For mean reversion / stat arb |
| momentum_score | Number | Momentum percentile or return % |
| rsi | Number | Relative Strength Index (0-100) |
| realized_vol | Number | 30-day annualized volatility |
| recommended_size | Number | Position size (% of capital) |
| timestamp | DateTime | Signal generation time (UTC) |

**Indexes:** timestamp, strategy_type, signal
**Retention:** Keep last 30 days
**Update Frequency:** Every 15 minutes (via Signal Engine)

---

## 3. paper_positions
**Purpose:** Track open positions in the paper trading portfolio.

| Column | Type | Description |
|--------|------|-------------|
| symbol | String | Stock ticker |
| quantity | Number | Number of shares (+ for long, - for short, 0 if closed) |
| entry_price | Number | Price at which position was opened |
| current_price | Number | Latest market price |
| unrealized_pnl | Number | Current P&L ($) |
| position_value | Number | Current position value ($) |
| strategy_type | String | Which strategy generated the signal |
| entry_date | DateTime | When position was opened (UTC) |

**Indexes:** symbol, entry_date
**Retention:** All open positions + last 1000 closed positions
**Update Frequency:** Every 30 minutes (Execution Engine updates prices)
**Max Positions:** 50 concurrent (portfolio constraint)

---

## 4. trade_log
**Purpose:** Complete audit trail of all executed trades.

| Column | Type | Description |
|--------|------|-------------|
| symbol | String | Stock ticker |
| side | String | "BUY" or "SELL" |
| quantity | Number | Number of shares |
| price | Number | Execution price |
| pnl | Number | Realized profit/loss (for sell orders) |
| strategy_type | String | Which strategy executed the trade |
| timestamp | DateTime | Execution time (UTC) |

**Indexes:** symbol, timestamp, side
**Retention:** All trades (permanent audit log)
**Update Frequency:** On every trade execution (max 30 min)
**Immutable:** Once inserted, never updated (audit trail integrity)

---

## 5. portfolio_summary
**Purpose:** Aggregate portfolio metrics (updated hourly).

| Column | Type | Description |
|--------|------|-------------|
| total_portfolio_value | Number | Current portfolio value ($) |
| total_unrealized_pnl | Number | Sum of all open position P&L ($) |
| realized_pnl | Number | Closed position P&L ($) |
| sharpe_ratio | Number | 30-day rolling Sharpe ratio |
| max_drawdown | Number | Maximum peak-to-trough decline (%) |
| win_rate | Number | % of closed trades that were profitable |
| cagr | Number | Compound annual growth rate (%) |
| num_positions | Number | Count of open positions |
| num_trades | Number | Total trades executed |
| timestamp | DateTime | Calculation timestamp (UTC) |

**Indexes:** timestamp
**Retention:** Keep all daily summaries (1 row/hour)
**Update Frequency:** Every hour (via Portfolio Aggregator)

---

## 6. strategy_breakdown
**Purpose:** Performance attribution by strategy.

| Column | Type | Description |
|--------|------|-------------|
| strategy_type | String | "mean_reversion", "momentum", or "statistical_arbitrage" |
| num_positions | Number | Open positions using this strategy |
| total_position_value | Number | Sum of position values ($) |
| total_unrealized_pnl | Number | P&L from this strategy ($) |
| timestamp | DateTime | Calculation time (UTC) |

**Indexes:** strategy_type, timestamp
**Retention:** Last 365 daily records
**Update Frequency:** Every hour (via Portfolio Aggregator)

---

## 7. ingestion_logs
**Purpose:** Monitor data ingestion health.

| Column | Type | Description |
|--------|------|-------------|
| run_id | String | Unique run identifier |
| timestamp | DateTime | Ingestion run time (UTC) |
| status | String | "success", "partial", "failed" |
| records_inserted | Number | Number of prices inserted |
| error_message | String | Error details (if failed) |

**Indexes:** timestamp, run_id
**Retention:** Last 30 days
**Update Frequency:** Every 5 minutes (after market data ingestion)

---

## Initialization Script

Run this once to create all tables:

```sql
-- n8n Data Table Creation (pseudo-SQL, uses n8n UI)
CREATE TABLE market_prices (
  symbol TEXT NOT NULL,
  timestamp DATETIME NOT NULL,
  close DECIMAL(10,2),
  open DECIMAL(10,2),
  high DECIMAL(10,2),
  low DECIMAL(10,2),
  volume INT
);

CREATE TABLE signals (
  symbol TEXT NOT NULL,
  strategy_type TEXT,
  signal INT,
  signal_strength DECIMAL(3,2),
  z_score DECIMAL(5,2),
  momentum_score DECIMAL(10,2),
  rsi DECIMAL(5,2),
  realized_vol DECIMAL(5,4),
  recommended_size DECIMAL(5,2),
  timestamp DATETIME
);

CREATE TABLE paper_positions (
  symbol TEXT PRIMARY KEY,
  quantity INT,
  entry_price DECIMAL(10,2),
  current_price DECIMAL(10,2),
  unrealized_pnl DECIMAL(15,2),
  position_value DECIMAL(15,2),
  strategy_type TEXT,
  entry_date DATETIME
);

CREATE TABLE trade_log (
  symbol TEXT,
  side TEXT,
  quantity INT,
  price DECIMAL(10,2),
  pnl DECIMAL(15,2),
  strategy_type TEXT,
  timestamp DATETIME
);

CREATE TABLE portfolio_summary (
  total_portfolio_value DECIMAL(15,2),
  total_unrealized_pnl DECIMAL(15,2),
  realized_pnl DECIMAL(15,2),
  sharpe_ratio DECIMAL(5,2),
  max_drawdown DECIMAL(5,2),
  win_rate DECIMAL(5,2),
  cagr DECIMAL(5,2),
  num_positions INT,
  num_trades INT,
  timestamp DATETIME
);

CREATE TABLE strategy_breakdown (
  strategy_type TEXT,
  num_positions INT,
  total_position_value DECIMAL(15,2),
  total_unrealized_pnl DECIMAL(15,2),
  timestamp DATETIME
);

CREATE TABLE ingestion_logs (
  run_id TEXT PRIMARY KEY,
  timestamp DATETIME,
  status TEXT,
  records_inserted INT,
  error_message TEXT
);
```

---

## Data Retention Policy

- **Real-time:** market_prices, signals, paper_positions (latest only)
- **30-day rolling:** signals, ingestion_logs
- **90-day rolling:** market_prices (for indicator calculations)
- **Permanent:** trade_log (immutable audit trail)
- **1-year history:** portfolio_summary, strategy_breakdown

To implement retention, add cleanup jobs in Portfolio Aggregator workflow.
